<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>PDF with Editable Annotations</title>
    <style>
      #container {
        position: relative;
        max-width: 800px;
        margin: 20px auto;
        border: 1px solid #ccc;
        padding: 10px;
      }
      .page-container {
        position: relative;
        margin-bottom: 30px;
      }
      canvas {
        display: block;
        border: 1px solid #999;
        max-width: 100%;
      }
      .annotation-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        /*  pointer-events: none;  disable pointer events on container to allow canvas interaction */
      }
      .annotation {
        position: absolute;
        background: rgba(255, 255, 0, 0.5);
        border: 1px dashed #ccc;
        padding: 4px 8px;
        cursor: move;
        pointer-events: auto;
        user-select: text;
        min-width: 200px;
        min-height: 100px;
        resize: both;
        overflow: auto;
        font-size: 14px;
        font-weight: 500;
      }

      .annotation-content {
        min-height: 40px;
        outline: none;
      }

      .reply-box {
        display: none;
        margin-top: 5px;
      }

      .reply-box textarea {
        width: 95%;
        height: 40px;
        resize: vertical;
      }

      .reply-box button {
        margin-top: 3px;
        padding: 2px 6px;
      }
    </style>
  </head>
  <body>
    <input type="file" id="fileInput" accept="application/pdf" />
    <button id="btnLoad">Load PDF</button>
    <button id="btnAddAnnotation">Add Annotation</button>
    <button id="btnExport">Export PDF</button>

    <div id="container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
      const container = document.getElementById("container");
      const fileInput = document.getElementById("fileInput");
      const btnLoad = document.getElementById("btnLoad");
      const btnAddAnnotation = document.getElementById("btnAddAnnotation");

      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

      let pdfDoc = null;
      let currentScale = 1.5;
      let pages = []; // store page info {container, canvas, annotationLayer, viewport}
      let addMode = false;

      btnLoad.addEventListener("click", async () => {
        if (!fileInput.files || !fileInput.files[0]) {
          alert("Please select a PDF file first");
          return;
        }

        const file = fileInput.files[0];
        const arrayBuffer = await file.arrayBuffer();

        container.innerHTML = "";
        pages = [];

        pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

        for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
          const page = await pdfDoc.getPage(pageNum);

          const viewport = page.getViewport({ scale: currentScale });

          const pageContainer = document.createElement("div");
          pageContainer.className = "page-container";
          pageContainer.style.width = viewport.width + "px";
          pageContainer.style.height = viewport.height + "px";
          pageContainer.style.position = "relative";

          const canvas = document.createElement("canvas");
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          canvas.style.display = "block";

          pageContainer.appendChild(canvas);

          const annotationLayer = document.createElement("div");
          annotationLayer.className = "annotation-layer";
          annotationLayer.style.width = viewport.width + "px";
          annotationLayer.style.height = viewport.height + "px";

          pageContainer.appendChild(annotationLayer);

          container.appendChild(pageContainer);

          const ctx = canvas.getContext("2d");
          await page.render({ canvasContext: ctx, viewport: viewport }).promise;

          pages.push({ pageContainer, canvas, annotationLayer, viewport });
        }
      });

      btnAddAnnotation.addEventListener("click", () => {
        if (pages.length === 0) {
          alert("Load a PDF first!");
          return;
        }
        const { annotationLayer } = pages[0];

        const annotation = document.createElement("div");
        annotation.className = "annotation";
        annotation.style.top = "20px";
        annotation.style.left = "20px";

        // inner editable content
        const content = document.createElement("div");
        content.className = "annotation-content";
        content.contentEditable = true;
        content.textContent = "Edit me";

        // reply button
        const replyBtn = document.createElement("button");
        replyBtn.textContent = "Reply";

        // reply box
        const replyBox = document.createElement("div");
        replyBox.className = "reply-box";
        replyBox.innerHTML = `
    <textarea placeholder="Write a reply..."></textarea><br>
    <button class="send-reply">Send</button>
  `;

        replyBtn.addEventListener("click", () => {
          // toggle reply box
          replyBox.style.display =
            replyBox.style.display === "none" ? "block" : "none";
        });

        // handle send
        replyBox.querySelector(".send-reply").addEventListener("click", () => {
          const txt = replyBox.querySelector("textarea").value.trim();
          if (txt) {
            // append as new paragraph below content
            const p = document.createElement("p");
            p.textContent = "Reply: " + txt;
            annotation.appendChild(p);
            replyBox.querySelector("textarea").value = "";
            replyBox.style.display = "none";
          }
        });

        annotation.appendChild(content);
        annotation.appendChild(replyBtn);
        annotation.appendChild(replyBox);

        makeDraggable(annotation);
        annotationLayer.appendChild(annotation);
        content.focus();
      });

      // btnAddAnnotation.addEventListener("click", () => {
      //   if (pages.length === 0) {
      //     alert("Load a PDF first!");
      //     return;
      //   }
      //   const { annotationLayer } = pages[0];

      //   const annotation = document.createElement("div");
      //   annotation.className = "annotation";
      //   annotation.contentEditable = true;
      //   annotation.style.top = "20px";
      //   annotation.style.left = "20px";
      //   annotation.style.width = "120px";
      //   annotation.style.height = "40px";
      //   annotation.textContent = "Edit me";

      //   makeDraggable(annotation); // your existing drag function
      //   annotationLayer.appendChild(annotation);
      //   annotation.focus();
      // });

      // btnAddAnnotation.addEventListener("click", () => {
      //   if (pages.length === 0) {
      //     alert("Load a PDF first!");
      //     return;
      //   }
      //   // Add annotation to the first page for demo
      // pages.forEach((p, index) => {
      //   p.annotationLayer.addEventListener("click", (ev) => {
      //     // mouse position relative to that page
      //     const rect = p.annotationLayer.getBoundingClientRect();
      //     const x = ev.clientX - rect.left;
      //     const y = ev.clientY - rect.top;

      //     const annotation = document.createElement("div");
      //     annotation.className = "annotation";
      //     annotation.contentEditable = true;
      //     annotation.style.top = y + "px";
      //     annotation.style.left = x + "px";
      //     annotation.style.width = "120px";
      //     annotation.style.height = "40px";
      //     annotation.textContent = "Edit me";

      //     makeDraggable(annotation);
      //     p.annotationLayer.appendChild(annotation);
      //     annotation.focus();
      //   });
      // });
      // });

      // let addMode = false;

      // btnAddAnnotation.addEventListener("click", () => {
      //   addMode = true; // next click adds annotation
      //   btnAddAnnotation.textContent = "Click on a page to place annotationâ€¦";
      // });

      // pages.forEach((p) => {
      //   p.pageContainer.addEventListener("click", (ev) => {
      //     if (!addMode) return; // only when in add mode
      //     addMode = false;
      //     btnAddAnnotation.textContent = "Add Annotation";

      //     const rect = p.pageContainer.getBoundingClientRect();
      //     const x = ev.clientX - rect.left;
      //     const y = ev.clientY - rect.top;

      //     const annotation = createAnnotation(x, y);
      //     p.annotationLayer.appendChild(annotation);
      //     annotation.focus();
      //   });
      // });

      // function createAnnotation(x, y) {
      //   const annotation = document.createElement("div");
      //   annotation.className = "annotation";
      //   annotation.contentEditable = true;
      //   annotation.style.top = y + "px";
      //   annotation.style.left = x + "px";
      //   annotation.style.width = "120px";
      //   annotation.style.height = "40px";
      //   annotation.textContent = "Edit me";

      //   makeDraggable(annotation);
      //   return annotation;
      // }

      const btnExport = document.getElementById("btnExport");

      btnExport.addEventListener("click", async () => {
        if (pages.length === 0) {
          alert("Load a PDF and add annotations first!");
          return;
        }

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
          unit: "px",
          format: [pages[0].viewport.width, pages[0].viewport.height],
        });

        for (let i = 0; i < pages.length; i++) {
          const page = pages[i];
          // Merge canvas + annotations by rendering page container div
          const pageContainer = page.pageContainer;

          // Use html2canvas to capture the page + annotations
          const canvas = await html2canvas(pageContainer, {
            scale: 2, // increase quality
            useCORS: true,
            backgroundColor: "#fff",
            logging: false,
          });

          const imgData = canvas.toDataURL("image/png");

          if (i > 0) {
            pdf.addPage([page.viewport.width, page.viewport.height]);
          }

          pdf.addImage(
            imgData,
            "PNG",
            0,
            0,
            page.viewport.width,
            page.viewport.height
          );
        }

        pdf.save("annotated.pdf");
      });

      // Make annotation draggable
      function makeDraggable(el) {
        let isDragging = false,
          startX,
          startY,
          startLeft,
          startTop;

        el.addEventListener("mousedown", (e) => {
          // Detect if weâ€™re in the native resize zone:
          const rect = el.getBoundingClientRect();
          const cornerSize = 16; // px of bottom-right corner reserved for resize
          const inResizeZone =
            e.clientX > rect.right - cornerSize &&
            e.clientY > rect.bottom - cornerSize;

          if (inResizeZone) {
            // let browser resize handle do its job, never set isDragging
            return;
          }

          // Otherwise, start dragging
          isDragging = true;
          startX = e.clientX;
          startY = e.clientY;
          startLeft = parseInt(el.style.left, 10) || 0;
          startTop = parseInt(el.style.top, 10) || 0;

          document.addEventListener("mousemove", onMouseMove);
          document.addEventListener("mouseup", onMouseUp);
        });

        function onMouseMove(e) {
          if (!isDragging) return;
          el.style.left = startLeft + (e.clientX - startX) + "px";
          el.style.top = startTop + (e.clientY - startY) + "px";
        }

        function onMouseUp() {
          isDragging = false;
          document.removeEventListener("mousemove", onMouseMove);
          document.removeEventListener("mouseup", onMouseUp);
        }
      }
    </script>
  </body>
</html>
